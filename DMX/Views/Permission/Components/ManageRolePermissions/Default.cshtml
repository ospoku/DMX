@using DMX.DataProtection
@using Microsoft.AspNetCore.Identity
@inject RoleManager<AppRole> rol;
@model DMX.ViewModels.RolePermissionVM
        
      
@* <div class="modal-header">
    <h6 class="mb-0">
        Manage Role Permissions<br />
        <b>@rol.FindByIdAsync(Model.RoleId).Result.Rolename</b>
    </h6>

    <button type="button" class="btn btn-sm btn-outline-danger"
            onclick="document.getElementById('ManageRolePermissionsDialog').close()">
        Close
    </button>
</div> *@

@* @{
    var allActions = Model.RoleClaims
        .Select(r => r.Action)
        .Distinct()
        .OrderBy(a => a)
        .ToList();
}
@*  
@using( id="rolePermissionsForm">
    <input type="hidden" name="roleId" value="@Model.RoleId" />

    <table class="table table-bordered">
        <thead>
            <tr>
                <th>Module</th>

                @foreach (var action in allActions)
                {
                    <th class="text-center">
                        <div class="perm-header"
                             data-action="@action">
                            @action
                        </div>
                    </th>
                }
            </tr>
        </thead>

        <tbody>
            @foreach (var module in Model.ModulePermissions)
            {
                <tr data-module="@module.Module">
                    <td><strong>@module.Module</strong></td>

                    @foreach (var action in allActions)
                    {
                        var perm = module.Permissions.FirstOrDefault(p => p.Action == action);

                        <td class="text-center">
                            @if (perm == null)
                            {
                                <span class="text-muted">—</span>
                            }
                            else
                            {
                                var cellId = $"{module.Module}_{perm.Action}".Replace(" ", "_");
                                var checkedState = perm.Selected ? "checked" : "";

                                <div class="perm-badge @(perm.Selected ? "active" : "")"
                                     data-action="@perm.Action"
                                     data-module="@perm.Module">

                                    <input type="checkbox"
                                           id="@cellId"
                                           name="selectedPermissions"
                                           class="perm-checkbox"
                                           value="@perm.Value"
                                           style="display:none"
                                           @checkedState />

                                    <label for="@cellId" style="cursor:pointer; margin:0;">
                                        @perm.Action
                                    </label>
                                </div>
                            }
                        </td>
                    }
                </tr>
            }
        </tbody>
    </table>



    <div class="mt-2">
        <button id="saveRolePermissions" type="button" class="btn btn-primary">Save</button>
        <button id="cancelRolePermissions" type="button" class="btn btn-secondary">Cancel</button>
    </div>
}
 *@









<div class="modal-header">
    <h6 class="mb-0">
        Manage Role Permissions<br/>
        <b>@( (await rol.FindByIdAsync(Model.RoleId)).Rolename )</b>
    </h6>
    <button type="button" class="btn btn-sm btn-outline-danger" onclick="document.getElementById('ManageRolePermissionsDialog').close()">Close</button>
</div>



@{
    // dynamic action columns (Action names must match DB exactly)
    var allActions = Model.RoleClaims.Select(r => r.Action).Distinct().OrderBy(a => a).ToList();
}

<form id="rolePermissionsForm">
    <input type="hidden" name="roleId" value="@Model.RoleId" />

    <div class="table-responsive">
        <table class="table table-bordered align-middle">
            <thead>
                <tr>
                    <th style="width:18%">Module</th>
                    @foreach (var action in allActions)
                    {
                        // header id and classes are generated from action string (safe as provided)
                        <th class="text-center" style="vertical-align:middle;">
                            <span id="header-@action"
                                  class="perm-header badge badge-@action"
                                  data-action="@action"
                                  title="Toggle all @action">
                                @action
                            </span>
                        </th>
                    }
                </tr>
            </thead>

            <tbody>
                @foreach (var module in Model.ModulePermissions)
                {
                    <tr data-module="@module.Module">
                        <td style="vertical-align:middle;"><strong>@module.Module</strong></td>

                        @foreach (var action in allActions)
                        {
                            var perm = module.Permissions.FirstOrDefault(p => p.Action == action);
                            <td class="text-center">
                                @if (perm == null)
                                {
                                    <span class="text-muted">—</span>
                                }
                                else
                                {
                                    var safeId = $"{module.Module}_{perm.Action}".Replace(" ", "_");
                                    var selectedClass = perm.Selected ? "selected" : "";
                                    var checkedAttr = perm.Selected ? "checked" : "";
                                    <span class="perm-badge badge badge-@perm.Action @selectedClass"
                                          data-action="@perm.Action"
                                          data-value="@perm.Value"
                                          title="@perm.Value">

                                        <!-- hidden checkbox keeps values for form submission -->
                                        <input type="checkbox"
                                               class="perm-checkbox"
                                               id="@safeId"
                                               name="selectedPermissions"
                                               value="@perm.Value"
                                               style="display:none"
                                               @checkedAttr />

                                        <label for="@safeId" style="cursor:pointer; margin:0; padding:6px 10px; display:inline-block;">
                                            @perm.Action
                                        </label>
                                    </span>
                                }
                            </td>
                        }
                    </tr>
                }
            </tbody>
        </table>
    </div>

    <div class="d-flex gap-2 justify-content-end mt-2">
        <button id="saveRolePermissions" type="button" class="btn btn-primary">Save</button>
        <button type="button" class="btn btn-secondary" onclick="document.getElementById('ManageRolePermissionsDialog').close()">Cancel</button>
    </div>
</form>

<!-- style: base + per-action colors -->












