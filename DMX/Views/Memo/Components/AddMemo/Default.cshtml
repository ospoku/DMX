@model DMX.ViewModels.AddMemoVM;

<dialog id="AddMemoDialog" class="col-md-6 border-0 rounded p-0">
    <div class="modal-header">
        <h6>Add Memo</h6>
        <button type="button" aria-label="Close"
                class="btn btn-sm btn-outline-danger"
                onclick="document.getElementById('AddMemoDialog').close()">
            Close
        </button>
    </div>

    @using (Html.BeginForm("AddMemo", "Memo", FormMethod.Post, new { id = "addMemoForm" }))
    {
        <div class="modal-body">
            <!-- Memo Title -->
            <div class="did-floating-label-content">
                <input type="text" asp-for="@Model.Title" class="did-floating-input" required />
                <label class="did-floating-label">Memo Title</label>
            </div>

            <!-- Memo Content -->
            <div class="form-group">
                <textarea id="MemoContent" class="dmx-textarea" asp-for="@Model.Content" placeholder="Memo Content"></textarea>
            </div>

            <!-- Select Approvers -->
         
                <select id="selectMemoUser" class="dmx-choices" asp-items="@Model.UsersList" asp-for="@Model.SelectedUsers"></select>
            
         
        </div>

        <!-- Footer -->
        <div class="modal-footer">
            <button id="btnAddMemo" type="button" class="btn btn-primary w-100">Save</button>
        </div>
    }
</dialog>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        const dialog = document.getElementById('AddMemoDialog');
        const addMemoForm = document.getElementById('addMemoForm');

        // Initialize Choices.js (or Select2 if you prefer)
        const userSelect = document.getElementById('selectMemoUser');
        const choices = new Choices(userSelect, {
            removeItemButton: true,
            placeholder: true,
            placeholderValue: 'Select approver(s)...',
            searchEnabled: true,
            position: 'bottom',
        });

        // Initialize TinyMCE when dialog opens
        dialog.addEventListener('show', () => {
            if (!tinymce.get('MemoContent')) {
                tinymce.init({
                    selector: '#MemoContent',
                    menubar: true,
                    toolbar: 'undo redo | bold italic underline | alignleft aligncenter alignright',
                    height: 250
                });
            }
        });

        // Close TinyMCE and reset when dialog closes
        dialog.addEventListener('close', () => {
            const editor = tinymce.get('MemoContent');
            if (editor) editor.remove();
            addMemoForm.reset();
        });

        // Save button handler
        document.getElementById('btnAddMemo').addEventListener('click', function (event) {
            event.preventDefault();

            if (!addMemoForm.checkValidity()) {
                addMemoForm.reportValidity();
                return;
            }

            const selectedUsers = choices.getValue(true);
            const memoContent = tinymce.get('MemoContent')?.getContent()?.trim();

            if (!selectedUsers || selectedUsers.length === 0) {
                Swal.fire('Error', 'Please select at least one user.', 'error');
                return;
            }

            if (!memoContent) {
                Swal.fire('Error', 'Memo content cannot be empty.', 'error');
                return;
            }

            Swal.fire({
                title: 'Are you sure?',
                text: 'Do you really want to save this record?',
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#3085d6',
                cancelButtonColor: '#d33',
                confirmButtonText: 'Yes, save it!'
            }).then((result) => {
                if (result.isConfirmed) {
                    addMemoForm.submit();
                }
            });
        });
    });
</script>
