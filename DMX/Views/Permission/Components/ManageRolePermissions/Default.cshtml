
@using Microsoft.AspNetCore.Identity
@inject RoleManager<AppRole> rol;
@model DMX.ViewModels.RolePermissionVM

@inject Microsoft.AspNetCore.DataProtection.IDataProtectionProvider DataProtectionProvider
@using Microsoft.AspNetCore.DataProtection
@{
    // Optional: create protector in view (same purpose string)
    var protector = DataProtectionProvider.CreateProtector("IdProtector");
}

<div class="modal-header">
    <h6 class="mb-0">
        Manage Role Permissions<br />
        <b>@rol.FindByIdAsync(Model.RoleId).Result.Rolename</b>
    </h6>

    <button type="button" class="btn btn-sm btn-outline-danger"
            onclick="document.getElementById('ManageRolePermissionsDialog').close()">
        Close
    </button>
</div> 

@{
    var allActions = Model.RoleClaims
                .Select(r => r.Action)
                .Distinct()
                .OrderBy(a => a)
                .ToList();
}

@using (Html.BeginForm("ManageRolePermissions", "Permission", FormMethod.Post))
{
    <input type="hidden" name="roleId" value="@protector.Protect(@Model.RoleId)" />

 
    <!-- Simple working version -->
    <table class="table table-bordered">
        <thead>
            <tr>
                <th>Module</th>
                @foreach (var action in allActions)
                {
                    <th class="text-center">@action</th>
                }
            </tr>
        </thead>
        <tbody>
            @foreach (var module in Model.ModulePermissions)
            {
                <tr>
                    <td><strong>@module.Module</strong></td>
                    @foreach (var action in allActions)
                    {
                        var perm = module.Permissions.FirstOrDefault(p => p.Action == action);
                        <td class="text-center">
                            @if (perm != null)
                            {
                                <div class="form-check form-check-inline">
                                    <input type="checkbox"
                                           id="@($"{module.Module}_{perm.Action}".Replace(" ", "_"))"
                                           name="SelectedClaimValues"
                                           class="perm-badge"
                                           value="@perm.Value"
                                           @(perm.Selected ? "checked" : "") />
                                </div>
                            }
                            else
                            {
                                <span class="text-muted">—</span>
                            }
                        </td>
                    }
                </tr>
            }
        </tbody>
    </table>

  
    <div class="mt-2">
        <button id="saveRolePermissions"  class="btn btn-primary">Save</button>
        <a id="cancelRolePermissions"  class="btn btn-secondary">Cancel</a>
    </div>
}



















